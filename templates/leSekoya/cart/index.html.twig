{% import "macros/search.html.twig" as search %}
{% import "macros/alertes.html.twig" as alert %}

{% extends "leSekoya/base.html.twig" %}
{% if app.request.session.get('shipping') %}
      {% set delivery = app.request.session.get('shipping') %}
{% endif %}


{% block title %}Cart {% endblock %}

{% block body %}

<style>
  .loader{
    display:none;
  }

</style>
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ path('home') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ path('articles') }}">Shop</a></li>
    <li class="breadcrumb-item active">Cart</li>
</ol>
{# {{ search.search(form) }} #}

  <!--================Cart Area =================-->
  <section class="cart_area">
    <div class="container div-primary">
    {% for item in app.flashes('success') %}
      {{ alert.alert(item,'success')}}
    {% endfor %}
    {% if app.request.session.get('panier') %}
      <!-- cart -->
      <div class="row">
        <div class="col-lg-12">
          <table class="table">
              <thead>
                  <tr>
                      <th scope="col">Product</th>
                      <th scope="col">Price</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Total</th>
                  </tr>
              </thead>
              <tbody>
                  {% for item in items %}
                  <tr>
                      <td width="30%">
                          <div class="media">
                              <div class="d-flex">
                                  {% for item in item.article.images|slice(0,1) %}
                                    <img src="{{ asset('img/article/' ~ item.name) }}" width="60px" alt="">
                                  {% else %}
                                    <img src="{{ asset('img/vide.png') }}" width="60px" alt="">
                                  {% endfor %}
                              </div>
                              <div class="media-body">
                                  <p class="text-justify">{{ item.article.title }}</p>
                              </div>
                          </div>
                      </td>
                      <td width="20%">
                          {{ item.article.price|number_format(2,'.',' ') }} {{ site.current}}
                      </td>
                      <td width="30%">
                          <form class="form-row" action="" method="post">
                            <div class="form-group col-3">
                              <input type="hidden" name="article_id" value="{{ item.article.id }}">
                              <input type="number" class="form-control" min="1" max="{{ item.article.quantity }}" name="qty" value="{{ item.quantite }}" >
                              <small id="helpId" class="text-muted">En Stock: {{ item.article.quantity  }} </small>
                            </div>
                            <div class="form-group col-2">
                              <button type="submit" class="btn btn-primary ml-1">
                                Appliquer
                              </button>
                            </div>
                          </form>
                      </td>
                      <td>
                          <h5>{{ (item.article.price * item.quantite) | number_format(2,'.',' ') ~ ' ' ~ site.current }}</h5>
                      </td>
                  </tr>
                  {% endfor %}
                  <tr>
                      <td colspan="3" >
                          <h5 class="float-right">Subtotal</h5>
                      </td>
                      <td>
                          <h5>
                            {{ total|number_format(2,'.',' ') }} {{ site.current }}
                          </h5> 
                      </td>
                  </tr>
                  <tr>
                      <td colspan="3" >
                          <h5 class="float-right">Shipping</h5>
                      </td>
                      <td>
                          <h5>
                            {{ (delivery) ? delivery.shippingAmount.amount:'0'|number_format(2,'.',' ') }} {{ site.current }}
                          </h5> 
                      </td>
                  </tr>
                  <tr>
                      <td colspan="3" >
                          <h5 class="float-right">Total</h5>
                      </td>
                      <td>
                          <h5><span class="text-danger" id="total"> {{ ( (total) + ((delivery) ? delivery.shippingAmount.amount:'0' ))|number_format(2,'.',' ') }} {{ site.current }} </span> </h5>
                      </td>
                  </tr>

              </tbody>
          </table>
        </div>
        <div class="col-lg-12">
          <form id="shipping-amount" method="POST" action="{{ path('cart_step_1') }}">
            <div class="row">
              <div class="col-lg-4">
                <p class="h4">Methode de paiment</p>
              <ul>
              {% for item in methodPayment %}                
                  <li class="filter-list">
                    <input class="pixel-radio" value="{{ item.id }}" {{ (  app.request.session.get('methodPayment') and app.request.session.get('methodPayment') == item.id )  ? 'checked':'' }}  type="radio" name="method">
                    <label for="{{ item.name }}">{{ item.name }}</label>
                  </li>
              {% endfor %}
              
              </ul>
              </div>
              <div class="col-lg-4">
                  <div class="row">
                    <div class="col-lg-12">
                      <p class="h4">Adress de livraison</p>
                      
                          {% if app.request.session.get('shipping') %}
                          <div class="shipping_box">
                            <div class="form-group loader-city">
                              <select class="custom-select" name="city" id="select-city">
                                {% for item in cities %}
                                <option name="city" value="{{ item.id}}">{{ item.name }}</option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="form-group">
                              <div id="loader-select-street" class="text-center loader">
                                <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                              </div>
                              <div id="js-select-street">
                                <select required class="custom-select select-street" id="streets" name="street">
                                  <option value="">Choisir le lieu de livraison</option>
                                  <option selected value="{{ delivery.id }}">{{ delivery.name }}</option>
                                  {% for item in streets %}
                                  <option value="{{ item.id }}">{{ item.name }}</option>
                                  {% endfor %}
                                </select>
                              </div>
                            </div>
                            <div class="card border-0">
                              <div id="loader-street-amount" class="text-center loader">
                                <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                              </div>
                              <div class="card-body  js-amount">
                                <p>Montant de la livraison</p>
                                <p class="h5">{{ delivery.shippingAmount.amount|number_format(2,'.',' ') }} {{ site.current }}</p> 
                              </div>
                            </div>
                          </div>
                          {% else %}
                          <div class="shipping_box">
                            <div class="form-group loader-city">
                              <select class="custom-select" name="city" id="select-city">
                                {% for item in cities %}
                                <option name="city" value="{{ item.id}}">{{ item.name }}</option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="form-group">
                              <div id="loader-select-street" class="text-center loader">
                                <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                              </div>
                              <div id="js-select-street">
                                <select required class="custom-select select-street" id="streets" name="street">
                                  <option value="">Choisir le lieu de livraison</option>
                                  {% for item in streets %}
                                  <option value="{{ item.id }}">{{ item.name }}</option>
                                  {% endfor %}
                                </select>
                              </div>
                            </div>
                            <div class="card border-0">
                              <div id="loader-street-amount" class="text-center loader">
                                <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                              </div>
                              <div class="card-body  js-amount"></div>
                              <p class="h4">Total : <span id="total"></span> </p>
                            </div>
                          </div>
                          {% endif %}
                    </div>
                  </div>
              </div>
              <div class="col-lg-4">
                <div class="row">
                <div class="col-lg-12">
                </div>
                  <div class="col text-center mb-2">
                      <a class="gray_btn btn-primary w-100" href="{{ path('articles') }}">Continue Shopping</a>
                  </div>
                  <div class="col-12">
                    <button type="sumbit" class="btn btn-warning w-100">Vérifier la commande</button>
                  </div>
                    <div class="col-lg-12">
                      <p class="h4">Connecter vous ou creer un compte pour commander</p>
                    </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <!-- empty shiipin cart --> 
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
        <div class="card-body text-center">
            <a class="btn bg-primary bnt-primary p-5 rounded-circle" href="#">
              <i class="fa fa-cart-arrow-down fa-4x" aria-hidden="true"></i>
            </a>
            <h3>{{'Empty cart'|trans }}</h3>
            <p>Ajouter au moins un article au panier</p>
            <a href="{{ path('articles') }}" class="btn btn-primary mt-2 w-100">View All products</a>
        </div>
      </div>
        </div>
      </div>
    {% endif %}
      <!-- receent article -->
      <div class="row">
        <div class="col-lg-12 my-5">
          <h3 class="text-center"></h3>
        </div>
      </div>
    </div>
  </section>
  <!--================End Cart Area =================-->
      <section class="section-margin calc-60px">
      <div class="container">
        <div class="section-intro pb-60px">
          <h2>Ces articles vous intersses ?</h2>
        </div>
        <div class="owl-carousel owl-theme" id="bestSellerCarousel">
          {% for item in rand_articles %}
              {{ include ('leSekoya/shop/_article.html.twig',{class:'col-xl-3'}) }}  
          {% endfor %}
        </div>
      </div>
    </section>
{% endblock %}

{% block javascripts %}
<script>
  $(document).ready(function(){

    function total(val = 0){
      let total = {{total }} + val ;
      return total
    }
    $(document).on('change','#select-city',function(){
      //on recupere l'id de la ville
      let value = $(this).val()
      // on envoie avec post
      $.ajax({
            url: "{{ path('client_shipping') }}",
            method: 'POST',
            dataType: 'json',
            data: {
                id_city: value,
            },
            beforeSend: function() {
                $('#loader-select-street').show()
                $('#js-select-street').hide()
                $('.js-amount').hide()
            },
            success: function(data) {
                $('#loader-select-street').hide()
                $('.select-street').remove()
                $('#js-select-street').html(data.response);
                $('#js-select-street').show()
            }
        }) // ./ajax
    })

    $(document).on('change','#streets',function(){
      let id = $(this).val()
      $.ajax({
        url:"{{ path('client_shipping_amount') }}",
        method:"POST",
        dataType:'json',
        data:{
          id_street : id
        },
        beforeSend:function(){
          $('#loader-street-amount').show()
          $('.js-amount').hide()

        },
        success:function(data){
          $('.js-amount').html(data.response).show()
          $('#loader-street-amount').hide()
          $('#total').text(total(data.amount).number_format(2,'.',''))

          // console.log(data.amount)
        }
      })
    })
  })
</script>
{% endblock %}
